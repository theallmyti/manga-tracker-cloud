<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manga Library</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020; --fg:#e9edf5; --muted:#a9b2c2; --accent:#7aa2ff;
  --glass:rgba(255,255,255,.07); --glass-strong:rgba(255,255,255,.10);
  --radius:16px; --blur:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --sidebar-w:320px; --scrim:rgba(0,0,0,.45);
}
body.light{
  --bg:#e9eef7; --fg:#0b1222; --muted:#44506a; --accent:#2b6fff;
  --glass:rgba(255,255,255,.65); --glass-strong:rgba(255,255,255,.75);
  --shadow:0 10px 26px rgba(0,0,0,.18);
}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at -10% 0%, #121a33 0%, transparent 60%),
    radial-gradient(900px 700px at 110% -10%, #0d1530 0%, transparent 60%),
    var(--bg);
  color:var(--fg);
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  letter-spacing:.2px;
  transition:background .25s ease, color .25s ease;
}
.container-narrow{max-width:1280px; margin:0 auto; padding:18px;}
.app-layout{position:relative}

/* Glass */
.glass{
  background:var(--glass);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(var(--blur)) saturate(135%);
  -webkit-backdrop-filter: blur(var(--blur)) saturate(135%);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
body.light .glass{border-color:rgba(0,0,0,.08)}

/* Sidebar */
.sidebar{
  position:fixed; top:0; left:0; bottom:0; width:var(--sidebar-w);
  padding:16px; display:flex; flex-direction:column; gap:16px;
  transform:translateX(-100%); transition:transform .25s ease; z-index:1001;
}
.sidebar.open{ transform:translateX(0); }
.scrim{
  position:fixed; inset:0; background:var(--scrim);
  opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease; z-index:1000;
}
.scrim.show{ opacity:1; visibility:visible; }
.logo-row{ display:flex; align-items:center; gap:10px; padding:6px 8px; }
.logo-mark{ width:28px; height:28px; border-radius:8px;
  background:linear-gradient(135deg, var(--accent), transparent);
  border:1px solid rgba(255,255,255,.25);
}
.logo-text{ font-weight:700; letter-spacing:.3px; }
.panel{ padding:12px; }
.panel .label{ font-size:12px; color:var(--muted); margin-bottom:6px }

/* Theme switch */
.switch-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.switch{ position:relative; width:48px; height:26px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; inset:0; cursor:pointer; background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.2); border-radius:999px; transition:background .2s ease, border-color .2s ease;
}
.slider:before{
  content:""; position:absolute; height:20px; width:20px; left:3px; top:50%;
  transform:translateY(-50%); background:#fff; border-radius:50%; transition:transform .2s ease;
}
.switch input:checked + .slider{ background:rgba(122,162,255,.35); border-color:rgba(122,162,255,.65); }
.switch input:checked + .slider:before{ transform:translate(21px,-50%); }

/* Topbar */
.topbar{ position:sticky; top:8px; z-index:5; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; }
.brand-btn{
  display:flex; align-items:center; gap:10px; background:transparent; border:none; color:inherit;
  cursor:pointer; padding:6px 8px; border-radius:10px;
}
.brand-btn:hover{ background:rgba(255,255,255,.1); }
.brand-text{ font-weight:700; letter-spacing:.4px; }

/* Controls */
.controls{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
.controls .control{
  background:var(--glass-strong); border:1px solid rgba(255,255,255,.12);
  border-radius:12px; padding:6px 8px; display:flex; align-items:center; gap:8px;
}
.control input, .control select{ appearance:none; background:transparent; border:none; color:inherit; outline:none; }
.control input::placeholder{ color:var(--muted) }

/* Grid */
.grid{ display:grid; gap:16px; margin-top:16px; grid-template-columns:repeat(2,minmax(0,1fr)); }
@media (min-width:640px){.grid{grid-template-columns:repeat(3,1fr)}}
@media (min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
@media (min-width:1024px){.grid{grid-template-columns:repeat(5,1fr)}}
@media (min-width:1280px){.grid{grid-template-columns:repeat(6,1fr)}}

/* Cards (uniform + mobile safe) */
.cardx{
  display:flex; flex-direction:column; justify-content:space-between;
  height:460px; overflow:visible; border-radius:16px; background:var(--glass);
  border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow);
  transition:transform .18s ease, box-shadow .18s ease;
}
.cardx:hover{ transform:translateY(-4px); }
.thumb{ position:relative; width:100%; flex:0 0 auto; height:65%; overflow:hidden; border-bottom:1px solid rgba(255,255,255,.1); }
.thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.thumb.placeholder{
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)),
    repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 10px, transparent 10px 20px);
}
.thumb.placeholder::after{
  content:"üñºÔ∏è"; position:absolute; inset:0; display:grid; place-items:center; font-size:28px; opacity:.6;
}
.card-bodyx{ flex:1 1 auto; display:flex; flex-direction:column; justify-content:space-between; padding:10px 12px 12px; }
.title{
  font-size:14px; font-weight:600; line-height:1.25; margin:0 0 4px 0;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
}
.info-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.meta{ font-size:12px; color:var(--muted) }
.status-pill{ padding:3px 8px; border-radius:999px; background:rgba(255,255,255,.07); font-size:11.5px }

/* Actions: perfect one-line buttons */
.actions{ display:flex; gap:6px; margin-top:auto; }
.btnx{
  flex:1; height:36px; display:flex; align-items:center; justify-content:center;
  border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05); color:var(--fg); font-size:.9rem; line-height:1; cursor:pointer;
  transition:background .15s ease,border-color .15s ease, box-shadow .15s ease;
  padding:0 10px;
}
.btnx:hover{ background:rgba(255,255,255,.09); }
.btn-dangerx{
  border-color:rgba(255,60,60,.45); color:#ff5b5b;
}
.btn-dangerx:hover{
  box-shadow:0 0 12px rgba(255,60,60,.6);
}

/* Inline SVG icon sizing inside buttons */
.btnx svg{ width:16px; height:16px; display:block; }

/* Auth card */
.auth-card{ padding:18px }

/* Modal: Add (translucent glass) */
.modal-scrim{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease; z-index:1100;
}
.modal-scrim.show{ opacity:1; visibility:visible; }
.modalx{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-48%) scale(.98);
  width:min(560px, 92vw); z-index:1101; opacity:0; visibility:hidden;
  transition:opacity .2s ease, transform .2s ease, visibility .2s ease;
}
.modalx.show{ opacity:1; visibility:visible; transform:translate(-50%,-50%) scale(1); }
.modal-body{ padding:16px }
.modal-row{ display:flex; gap:10px; }
.modal-row > *{ flex:1 }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px }
.inputx{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
  background:var(--glass-strong); color:inherit; outline:none;
}
.inputx::placeholder{ color:var(--muted) }

/* Modal: Delete (solid black, slight blur) */
.del-scrim{
  position:fixed; inset:0; background:rgba(0,0,0,.8);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease; z-index:1200;
}
.del-scrim.show{ opacity:1; visibility:visible; }
.del-modal{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-48%) scale(.98);
  width:min(560px, 92vw); z-index:1201; opacity:0; visibility:hidden;
  transition:opacity .2s ease, transform .2s ease, visibility .2s ease;
}
.del-modal.show{ opacity:1; visibility:visible; transform:translate(-50%,-50%) scale(1); }
.del-body{ padding:18px }

/* Toasts */
.glass-toast-wrap{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  z-index:1300; display:flex; flex-direction:column; gap:8px; align-items:center;
}
.glass-toast{
  min-width:200px; max-width:90vw;
  padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  color:inherit; font-weight:600;
  opacity:0; transform:translateY(8px);
  transition:opacity .3s ease, transform .3s ease;
}
.glass-toast.show{ opacity:1; transform:translateY(0); }
.toast-success{ background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color:#22c55e; }
.toast-danger{ background: rgba(239,68,68,0.25); border-color: rgba(239,68,68,0.45); color:#ef4444; }

/* Misc */
.text-mutedx{ color:var(--muted) }
.hidden{ display:none }
</style>
</head>
<body>
  <!-- Sidebar + scrim -->
  <aside id="sidebar" class="sidebar glass" aria-hidden="true">
    <div class="logo-row">
      <div class="logo-mark" aria-hidden="true"></div>
      <div class="logo-text">Manga Library</div>
    </div>

    <div class="glass panel">
      <div class="label">Theme</div>
      <div class="switch-row">
        <span class="text-mutedx">Toggle</span>
        <label class="switch">
          <input type="checkbox" id="themeSwitch" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="glass panel" id="userPanel">
      <div class="label">Account</div>
      <div id="userEmail" class="mb-2 text-truncate"></div>
      <button id="logoutBtn" class="btnx" style="width:100%">Logout</button>
    </div>

    <!-- Add button (only after login) -->
    <button id="openAdd" class="btnx hidden">Add</button>

    <div class="text-mutedx mt-auto" style="font-size:12px">&copy; <span id="year"></span> Manga Library</div>
  </aside>
  <div id="scrim" class="scrim" tabindex="-1" aria-hidden="true"></div>

  <!-- Add Modal (translucent) -->
  <div id="modalScrim" class="modal-scrim" tabindex="-1" aria-hidden="true"></div>
  <div id="addModal" class="modalx">
    <div class="glass modal-body">
      <h5 class="mb-3">Add Series</h5>
      <div class="mb-2">
        <label class="form-label small text-mutedx">Title *</label>
        <input id="m_title" class="inputx" placeholder="Enter manga title" />
      </div>
      <div class="modal-row mb-2">
        <div>
          <label class="form-label small text-mutedx">Chapter</label>
          <input id="m_chapter" class="inputx" type="number" inputmode="numeric" placeholder="e.g. 45" />
        </div>
        <div>
          <label class="form-label small text-mutedx">Status</label>
          <select id="m_status" class="inputx">
            <option value="Ongoing">Ongoing</option>
            <option value="Completed">Completed</option>
            <option value="Dropped">Dropped</option>
            <option value="Plan to Read">Plan to Read</option>
          </select>
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label small text-mutedx">URL</label>
        <input id="m_url" class="inputx" placeholder="https://example.com/manga/..." />
      </div>
      <div class="mb-2">
        <label class="form-label small text-mutedx">Cover URL</label>
        <input id="m_cover" class="inputx" placeholder="https://image.host/cover.jpg" />
      </div>
      <div class="modal-actions">
        <button id="cancelAdd" class="btnx">Cancel</button>
        <button id="saveAdd" class="btnx">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal (solid black scrim with blur) -->
  <div id="delScrim" class="del-scrim" tabindex="-1" aria-hidden="true"></div>
  <div id="delModal" class="del-modal">
    <div class="glass del-body">
      <h5 class="mb-2">Delete Entry</h5>
      <p class="mb-3 text-mutedx">Are you sure you want to delete this entry? This action cannot be undone.</p>
      <div class="d-flex justify-content-end gap-2">
        <button id="delCancel" class="btnx">Cancel</button>
        <button id="delConfirm" class="btnx btn-dangerx">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="glass-toast-wrap"></div>

  <div class="container-narrow app-layout">
    <!-- Top bar -->
    <header class="topbar glass">
      <button id="openSidebar" class="brand-btn" aria-label="Open sidebar">
        <div class="logo-mark" aria-hidden="true"></div>
        <span class="brand-text">Manga Library</span>
      </button>
      <div></div>
    </header>

    <!-- Auth (shown only when logged out) -->
    <div id="auth"></div>

    <!-- App -->
    <section id="app" class="hidden">
      <div class="glass p-3 mt-3">
        <div class="controls">
          <div class="control flex-grow-1">
            <span>üîç</span>
            <input id="searchInput" type="search" placeholder="Search title..." class="w-100">
          </div>
          <div class="control">
            <label class="me-1 text-mutedx">Status</label>
            <select id="statusFilter">
              <option value="">All</option>
              <option value="done">Done</option>
              <option value="notdone">Not Done</option>
            </select>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <div id="resultCount" class="text-mutedx">Loading‚Ä¶</div>
        <button id="refreshBtn" class="btnx" style="flex:0 0 auto; max-width:120px">Refresh</button>
      </div>

      <div id="grid" class="grid"></div>
    </section>
  </div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://qdbfokgiwrococaxifkn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkYmZva2dpd3JvY29jYXhpZmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDU0MTcsImV4cCI6MjA3NzkyMTQxN30.rQz9t-NnU_Ahn-8avkUlhry4BFYyw6PVfgZNo-KFK1A";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== Helpers ===== */
const $ = (s,p=document)=>p.querySelector(s);
const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
$("#year").textContent = new Date().getFullYear();

/* ===== Elements ===== */
const el = {
  sidebar: $("#sidebar"), scrim: $("#scrim"), openSidebar: $("#openSidebar"),
  themeSwitch: $("#themeSwitch"),
  userEmail: $("#userEmail"), logoutBtn: $("#logoutBtn"), openAdd: $("#openAdd"),
  modalScrim: $("#modalScrim"), addModal: $("#addModal"), saveAdd: $("#saveAdd"), cancelAdd: $("#cancelAdd"),
  m_title: $("#m_title"), m_chapter: $("#m_chapter"), m_status: $("#m_status"), m_url: $("#m_url"), m_cover: $("#m_cover"),
  delScrim: $("#delScrim"), delModal: $("#delModal"), delCancel: $("#delCancel"), delConfirm: $("#delConfirm"),
  toastWrap: $("#toastWrap"),
  auth: $("#auth"), app: $("#app"), grid: $("#grid"), search: $("#searchInput"), status: $("#statusFilter"), refresh: $("#refreshBtn"), resultCount: $("#resultCount"),
};

let cache = [];
let userId = null;
let pendingDeleteId = null;

/* ===== Theme (persist) ===== */
(function initTheme(){
  const saved = localStorage.getItem("theme") || "dark";
  setTheme(saved);
  el.themeSwitch.checked = (saved === "light");
  el.themeSwitch.addEventListener("change", ()=>{
    const mode = el.themeSwitch.checked ? "light" : "dark";
    setTheme(mode); localStorage.setItem("theme", mode);
  });
  function setTheme(mode){
    if(mode==="light"){ document.body.classList.add("light"); }
    else { document.body.classList.remove("light"); }
  }
})();

/* ===== Sidebar open/close ===== */
function openSidebar(){ el.sidebar.classList.add("open"); el.scrim.classList.add("show"); }
function closeSidebar(){ el.sidebar.classList.remove("open"); el.scrim.classList.remove("show"); }
el.openSidebar.addEventListener("click", openSidebar);
el.scrim.addEventListener("click", closeSidebar);
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ closeSidebar(); closeAddModal(); closeDelModal(); }});

/* ===== Auth ===== */
initAuth();
async function initAuth(){
  const { data:{ session } } = await supabase.auth.getSession();
  renderAuth(session?.user || null);
  supabase.auth.onAuthStateChange((_e, session)=> renderAuth(session?.user || null));
}
function renderAuth(user){
  if(user){
    userId = user.id;
    el.userEmail.textContent = user.email || "";
    el.logoutBtn.onclick = async()=>{ await supabase.auth.signOut(); location.reload(); };
    el.auth.innerHTML = "";
    el.app.classList.remove("hidden");
    el.openAdd.classList.remove("hidden");
    el.openAdd.onclick = openAddModal;
    wireControls();
    loadData();
  } else {
    userId = null;
    el.app.classList.add("hidden");
    el.openAdd.classList.add("hidden");
    el.auth.innerHTML = `
      <div class="glass auth-card mt-3">
        <h5 class="mb-3">Login or Sign Up</h5>
        <input id="email" class="form-control mb-2" placeholder="Email">
        <input id="password" type="password" class="form-control mb-3" placeholder="Password">
        <div class="d-flex gap-2">
          <button id="login" class="btnx">Login</button>
          <button id="signup" class="btnx">Sign Up</button>
        </div>
      </div>`;
    $("#login").onclick = login;
    $("#signup").onclick = signup;
  }
}
async function login(){
  const email = $("#email").value.trim();
  const password = $("#password").value.trim();
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) alert(error.message);
}
async function signup(){
  const email = $("#email").value.trim();
  const password = $("#password").value.trim();
  const { error } = await supabase.auth.signUp({ email, password });
  if(error) alert(error.message);
  else alert("Check your email to verify, then log in.");
}

/* ===== Controls ===== */
function wireControls(){
  el.refresh.onclick = loadData;
  el.search.addEventListener("input", debounce(applyFilters, 200));
  el.status.addEventListener("change", applyFilters);
}
function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ===== Data load / render ===== */
async function loadData(){
  el.resultCount.textContent = "Loading‚Ä¶";
  el.grid.innerHTML = "";
  const { data, error } = await supabase
    .from("manga")
    .select("*")
    .eq("user_id", userId)
    .order("title", { ascending: true });

  if(error){ console.error(error); el.resultCount.textContent = "Failed to load."; return; }
  cache = data || [];
  applyFilters();
}
function applyFilters(){
  const q = el.search.value.trim().toLowerCase();
  const statusSel = el.status.value; // "", "done", "notdone"
  let rows = cache.filter(r => (r.title||"").toLowerCase().includes(q));
  if(statusSel==="done") rows = rows.filter(r => String(r.status||"").toLowerCase().includes("(done"));
  if(statusSel==="notdone") rows = rows.filter(r => !String(r.status||"").toLowerCase().includes("(done"));
  renderGrid(rows);
  el.resultCount.textContent = `${rows.length} result${rows.length===1?"":"s"}`;
}
function renderGrid(rows){
  el.grid.innerHTML = "";
  const frag = document.createDocumentFragment();
  for(const r of rows){ frag.appendChild(createCard(r)); }
  el.grid.appendChild(frag);
}

/* ===== Card builder + lazy images ===== */
const io = new IntersectionObserver((entries)=>{
  for(const e of entries){
    if(e.isIntersecting){ const img=e.target; img.src=img.dataset.src; io.unobserve(img); }
  }
},{rootMargin:"200px"});

function createCard(row){
  const card = document.createElement("article");
  card.className = "cardx";

  // Cover
  const thumb = document.createElement("div");
  thumb.className = "thumb";
  const link = document.createElement("a");
  link.className = "cover-link";
  link.target = "_blank"; link.rel = "noopener";
  link.href = row.url || "javascript:void(0)";
  const img = document.createElement("img");
  const cover = (row.cover_url && row.cover_url !== "NOT_FOUND") ? row.cover_url : "";
  if(cover){ img.loading="lazy"; img.alt=row.title||""; img.dataset.src=cover; io.observe(img); }
  else { thumb.classList.add("placeholder"); }
  link.appendChild(img); thumb.appendChild(link);

  // Body
  const body = document.createElement("div");
  body.className = "card-bodyx";
  const title = document.createElement("h3");
  title.className = "title"; title.textContent = row.title || "Untitled";

  const infoRow = document.createElement("div");
  infoRow.className = "info-row";
  const meta = document.createElement("div");
  meta.className = "meta"; meta.innerHTML = `<span>Chapter ${row.chapter ?? 0}</span>`;
  const statusPill = document.createElement("span");
  statusPill.className = "status-pill";
  statusPill.textContent = (row.status ?? "").toString() || "‚Äî";
  infoRow.append(meta, statusPill);

  const actions = document.createElement("div");
  actions.className = "actions";
  const btnPlus = b("Ôºã1"), btnSet=b("Set"), btnDone=b("Done"), btnDel=bIcon();
  btnPlus.onclick = ()=> updateChapter(row.id, (row.chapter||0)+1);
  btnSet.onclick  = ()=>{ const v=prompt("Set chapter number:", row.chapter??0);
                          if(v!==null && !Number.isNaN(Number(v))) updateChapter(row.id, Number(v)); };
  btnDone.onclick = ()=> markDone(row.id);
  btnDel.onclick  = ()=> openDelModal(row.id);
  actions.append(btnPlus, btnSet, btnDone, btnDel);

  body.append(title, infoRow, actions);
  card.append(thumb, body);
  return card;

  function b(txt){ const x=document.createElement("button"); x.className="btnx"; x.textContent=txt; return x; }
  function bIcon(){
    const x=document.createElement("button"); x.className="btnx btn-dangerx";
    x.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 1 1 0 2h-1v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7H4a1 1 0 1 1 0-2h4V4a1 1 0 0 1 1-1zm1 4v12h4V7h-4z"/>
      </svg>`;
    return x;
  }
}

/* ===== Add Modal ===== */
function openAddModal(){
  el.m_title.value=""; el.m_chapter.value=""; el.m_status.value="Ongoing";
  el.m_url.value=""; el.m_cover.value="";
  el.modalScrim.classList.add("show"); el.addModal.classList.add("show");
}
function closeAddModal(){ el.modalScrim.classList.remove("show"); el.addModal.classList.remove("show"); }
el.modalScrim.addEventListener("click", closeAddModal);
el.cancelAdd.addEventListener("click", closeAddModal);
el.saveAdd.addEventListener("click", onSaveAdd);

async function onSaveAdd(){
  const title = el.m_title.value.trim();
  if(!title){ alert("Title is required."); return; }
  const chapter = Number(el.m_chapter.value || 0);
  const status = el.m_status.value;
  const url = el.m_url.value.trim() || null;
  const cover_url = el.m_cover.value.trim() || null;

  let source = null;
  if(url){ try { source = new URL(url).hostname; } catch { source = null; } }

  el.saveAdd.disabled = true;
  try{
    const { error } = await supabase.from("manga").insert({ user_id:userId, title, chapter, status, url, cover_url, source });
    if(error) throw error;
    closeAddModal();
    loadData();
    toast("Series added successfully.", "success");
  } catch(err){
    console.error(err); alert(err.message || "Failed to add series.");
  } finally { el.saveAdd.disabled = false; }
}

/* ===== Delete Modal (custom confirm) ===== */
function openDelModal(id){
  pendingDeleteId = id;
  el.delScrim.classList.add("show"); el.delModal.classList.add("show");
}
function closeDelModal(){ el.delScrim.classList.remove("show"); el.delModal.classList.remove("show"); pendingDeleteId=null; }
el.delScrim.addEventListener("click", closeDelModal);
el.delCancel.addEventListener("click", closeDelModal);
el.delConfirm.addEventListener("click", async ()=>{
  if(!pendingDeleteId) return;
  try{
    await supabase.from("manga").delete().eq("id", pendingDeleteId);
    if(navigator.vibrate) navigator.vibrate(40);  // gentle haptic
    closeDelModal();
    loadData();
    toast("Deleted successfully.", "danger");
  }catch(err){
    console.error(err); alert(err.message || "Failed to delete.");
  }
});

/* ===== Mutations ===== */
async function updateChapter(id,val){
  await supabase.from("manga").update({ chapter: val }).eq("id", id);
  loadData();
}
async function markDone(id){
  const { data, error } = await supabase.from("manga").select("chapter").eq("id", id).single();
  const ch = error ? null : (data?.chapter ?? null);
  const statusVal = (ch===null) ? "Completed" : `Chapter ${ch}(Done)`;
  await supabase.from("manga").update({ status: statusVal }).eq("id", id);
  loadData();
}

/* ===== Toasts ===== */
function toast(message, type="success"){
  const t = document.createElement("div");
  t.className = `glass-toast ${type==="danger"?"toast-danger":"toast-success"}`;
  t.textContent = message;
  el.toastWrap.appendChild(t);
  // Animate in
  requestAnimationFrame(()=> t.classList.add("show"));
  // Auto dismiss
  setTimeout(()=>{
    t.classList.remove("show");
    setTimeout(()=> t.remove(), 300);
  }, 2000);
}

/* ===== Utilities ===== */
function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
</script>
</body>
</html>
