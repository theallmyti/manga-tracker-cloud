<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manga Tracker Cloud</title>

<!-- Dependencies -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Style -->
<style>
body {
  background: #0f172a;
  color: #f1f5f9;
  font-family: "Inter", system-ui, sans-serif;
  padding: 1.5rem;
}

h2 {
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 1rem;
}

.card {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
}

a {
  color: #38bdf8;
  font-weight: 500;
  text-decoration: none;
}
a:hover {
  color: #7dd3fc;
  text-decoration: underline;
}

input, select, button {
  border-radius: 0.5rem!important;
}

.btn {
  font-size: 0.85rem;
  font-weight: 500;
  border: none;
  transition: opacity 0.2s ease;
}
.btn:hover {
  opacity: 0.85;
}

.status-tag {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  border-radius: 0.4rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: #0f172a;
}
.status-ongoing {
  background: #38bdf8;
}
.status-completed {
  background: #22c55e;
}

.chapter-info {
  font-size: 0.9rem;
  margin-top: 0.25rem;
  color: #cbd5e1;
}

.card-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
  color: #f8fafc;
}

#filterRow {
  align-items: center;
  gap: 0.5rem;
}
</style>
</head>

<body>
<div class="container">
  <h2>ðŸŒ¸ Manga Tracker Cloud</h2>
  <div id="auth" class="mb-4"></div>

  <div id="app" style="display:none">
    <div class="d-flex flex-wrap mb-3 gap-2" id="filterRow">
      <input id="searchInput" class="form-control flex-grow-1" placeholder="ðŸ” Search manga title...">
      <select id="statusFilter" class="form-select w-auto">
        <option value="All">All</option>
        <option value="Ongoing">Ongoing</option>
        <option value="Completed">Completed</option>
      </select>
      <input id="newTitle" class="form-control w-auto" placeholder="Add new manga title">
      <button id="addBtn" class="btn btn-success">Add</button>
    </div>
    <div id="list" class="row g-3"></div>
  </div>
</div>

<!-- Script -->
<script>
const SUPABASE_URL = "https://qdbfokgiwrococaxifkn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkYmZva2dpd3JvY29jYXhpZmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDU0MTcsImV4cCI6MjA3NzkyMTQxN30.rQz9t-NnU_Ahn-8avkUlhry4BFYyw6PVfgZNo-KFK1A";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allManga = []; // cache for local filtering

// === AUTH HANDLING ===
async function checkSession(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(session) showApp(session.user);
  else showLogin();
}

supabase.auth.onAuthStateChange((_event, session) => {
  if(session) showApp(session.user);
  else showLogin();
});

function showLogin(){
  const div=document.getElementById("auth");
  div.innerHTML=`
    <div class="card p-3 mb-3">
      <h5>Login or Sign Up</h5>
      <input id="email" class="form-control mb-2" placeholder="Email">
      <input id="password" type="password" class="form-control mb-2" placeholder="Password">
      <div class="d-flex gap-2">
        <button class="btn btn-primary flex-fill" id="loginBtn">Login</button>
        <button class="btn btn-outline-light flex-fill" id="signupBtn">Sign Up</button>
      </div>
    </div>`;
  document.getElementById("loginBtn").onclick=login;
  document.getElementById("signupBtn").onclick=signup;
}

async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const { data, error }=await supabase.auth.signInWithPassword({ email, password });
  if(error) alert(error.message);
  else showApp(data.user);
}

async function signup(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const { error }=await supabase.auth.signUp({ email, password });
  if(error) alert(error.message);
  else alert("Check your email for a verification link, then log in.");
}

// === APP DISPLAY ===
async function showApp(user){
  document.getElementById("auth").innerHTML=
    `Logged in as ${user.email}
     <button class="btn btn-sm btn-outline-danger ms-2" id="logoutBtn">Logout</button>`;
  document.getElementById("logoutBtn").onclick=async()=>{await supabase.auth.signOut();location.reload();};
  document.getElementById("app").style.display="block";
  document.getElementById("addBtn").onclick=addManga;
  document.getElementById("searchInput").oninput=applyFilters;
  document.getElementById("statusFilter").onchange=applyFilters;
  loadManga();
}

// === CRUD OPERATIONS ===
async function loadManga(){
  const list=document.getElementById("list");
  list.innerHTML="<p>Loading...</p>";

  const { data:{ user } } = await supabase.auth.getUser();
  const { data, error } = await supabase
    .from("manga")
    .select("*")
    .eq("user_id", user.id)
    .order("title", { ascending:true });

  if(error){console.error(error); list.innerHTML="<p class='text-danger'>Failed to load manga.</p>"; return;}
  allManga = data;
  applyFilters();
}

function applyFilters(){
  const term = document.getElementById("searchInput").value.trim().toLowerCase();
  const status = document.getElementById("statusFilter").value;
  let filtered = allManga.filter(it => it.title.toLowerCase().includes(term));
  if(status !== "All") filtered = filtered.filter(it => (it.status ?? "Ongoing") === status);
  render(filtered);
}

// === UI RENDERING ===
function render(items){
  const c=document.getElementById("list");
  c.innerHTML="";
  if(!items.length){
    c.innerHTML="<p class='text-muted'>No matching manga found.</p>";
    return;
  }

  items.forEach(it=>{
    const col=document.createElement("div");
    col.className="col-12 col-md-6 col-lg-4";
    const card=document.createElement("div");
    card.className="card p-3 h-100 d-flex flex-column justify-content-between";

    const status = (it.status ?? "Ongoing");
    const tagClass = status === "Completed" ? "status-completed" : "status-ongoing";

    card.innerHTML=`
      <div>
        <h5 class="card-title">${it.title}</h5>
        <div class="chapter-info">
          Chapter ${it.chapter ?? 0}
          <span class="status-tag ${tagClass}">${status}</span>
        </div>
        ${it.url ? `<div class="mt-1"><a href="${it.url}" target="_blank">ðŸ“– Read on site</a></div>` : ""}
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        <button class="btn btn-sm btn-success flex-fill">+1</button>
        <button class="btn btn-sm btn-secondary flex-fill">Set</button>
        <button class="btn btn-sm btn-outline-light flex-fill">Done</button>
        <button class="btn btn-sm btn-danger flex-fill">ðŸ—‘</button>
      </div>
    `;

    const [plus,set,done,del]=card.querySelectorAll("button");
    plus.onclick=()=>updateChapter(it.id,(it.chapter||0)+1);
    set.onclick=()=>{const val=prompt("Set chapter number:",it.chapter);if(val!==null)updateChapter(it.id,Number(val));};
    done.onclick=()=>updateStatus(it.id,"Completed");
    del.onclick=()=>deleteManga(it.id);

    col.append(card);
    c.append(col);
  });
}

// === CRUD FUNCTIONS ===
async function addManga(){
  const title=document.getElementById("newTitle").value.trim();
  if(!title) return;
  const { data:{ user } } = await supabase.auth.getUser();
  await supabase.from("manga").insert({ user_id:user.id, title, status:"Ongoing", chapter:0 });
  document.getElementById("newTitle").value="";
  loadManga();
}

async function updateChapter(id,val){
  await supabase.from("manga").update({chapter:val}).eq("id",id);
  loadManga();
}

async function updateStatus(id,val){
  await supabase.from("manga").update({status:val}).eq("id",id);
  loadManga();
}

async function deleteManga(id){
  if(confirm("Delete this entry?")){
    await supabase.from("manga").delete().eq("id",id);
    loadManga();
  }
}

// === INITIALIZE ===
checkSession();
</script>
</body>
</html>
